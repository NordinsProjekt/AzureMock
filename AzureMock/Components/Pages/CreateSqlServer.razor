@page "/create-sql-server"
@layout AzurePortalLayout
@rendermode InteractiveServer
@using AzureMock.Components.Shared

<PageTitle>Create SQL Server - Microsoft Azure</PageTitle>

<div class="azure-container">
    <div class="azure-breadcrumb">
        <a href="/">Home</a>
        <span>/</span>
        <a href="/sql-servers">SQL Servers</a>
        <span>/</span>
        <span>Create SQL Server</span>
    </div>

    <div class="azure-wizard">
        <div class="azure-wizard-header">
            <h2>Create SQL Server</h2>
            <p>Set up a new Azure SQL Server instance</p>
        </div>

        <div class="azure-wizard-tabs">
            <div class="azure-wizard-tab @(CurrentTab == 0 ? "active" : "")" @onclick='() => CurrentTab = 0'>
                Basics
            </div>
            <div class="azure-wizard-tab @(CurrentTab == 1 ? "active" : "")" @onclick='() => CurrentTab = 1'>
                Networking
            </div>
            <div class="azure-wizard-tab @(CurrentTab == 2 ? "active" : "")" @onclick='() => CurrentTab = 2'>
                Security
            </div>
            <div class="azure-wizard-tab @(CurrentTab == 3 ? "active" : "")" @onclick='() => CurrentTab = 3'>
                Additional settings
            </div>
            <div class="azure-wizard-tab @(CurrentTab == 4 ? "active" : "")" @onclick='() => CurrentTab = 4'>
                Tags
            </div>
            <div class="azure-wizard-tab @(CurrentTab == 5 ? "active" : "")" @onclick='() => CurrentTab = 5'>
                Review + create
            </div>
        </div>

        <div class="azure-wizard-content">
            @if (CurrentTab == 0)
            {
                <div class="azure-form-section">
                    <h3>Project Details</h3>
                    
                    <div class="azure-form-group">
                        <label class="label-with-tooltip">
                            Subscription *
                            <InfoTooltip Title="Azure Subscription">
                                A subscription is a billing container that groups your resources together. All resources in a subscription are billed together and share the same credit limit.
                                <strong>Student subscription provides $100 in free credits.</strong>
                            </InfoTooltip>
                        </label>
                        <select>
                            <option value="azure-student" selected>Azure for Students</option>
                            <option value="pay-as-you-go">Pay-As-You-Go</option>
                            <option value="free-trial">Free Trial</option>
                        </select>
                        <small>All resources in an Azure subscription are billed together</small>
                    </div>
                    
                    <div class="azure-form-group">
                        <label class="label-with-tooltip">
                            Resource Group *
                            <InfoTooltip Title="Resource Groups">
                                A resource group is a logical container that holds related Azure resources. It helps you organize and manage resources that share the same lifecycle.
                                <strong>No additional cost</strong> - Resource groups are free to create and use.
                            </InfoTooltip>
                        </label>
                        <select @bind="NewServer.ResourceGroup">
                            <option value="">Select a resource group</option>
                            @foreach (var rg in ResourceGroups)
                            {
                                <option value="@rg.Name">@rg.Name</option>
                            }
                        </select>
                        <small>Or <a href="#" @onclick="ShowCreateResourceGroup" @onclick:preventDefault>create new</a></small>
                    </div>

                    @if (ShowNewResourceGroup)
                    {
                        <div class="azure-form-group">
                            <label>New Resource Group Name *</label>
                            <input type="text" @bind="NewResourceGroupName" placeholder="e.g., myResourceGroup" />
                        </div>
                    }
                </div>

                <div class="azure-form-section">
                    <h3>Server Details</h3>
                    
                    <div class="azure-form-group">
                        <label>Server Name *</label>
                        <input type="text" @bind="NewServer.Name" placeholder="e.g., mysqlserver" />
                        <small>Server name must be globally unique. Only lowercase letters, numbers, and hyphens allowed.</small>
                        @if (!string.IsNullOrEmpty(ServerNameError))
                        {
                            <div class="error">@ServerNameError</div>
                        }
                    </div>

                    <div class="azure-form-group">
                        <label class="label-with-tooltip">
                            Location *
                            <InfoTooltip Title="Server Location">
                                The Azure region where your SQL Server will be hosted. Choose a location closest to your users for better performance.
                                <strong>Different regions may have different pricing.</strong> Closer regions typically offer lower latency.
                            </InfoTooltip>
                        </label>
                        <select @bind="NewServer.Location">
                            <option value="">Select a location</option>
                            @foreach (var location in Locations)
                            {
                                <option value="@location">@location</option>
                            }
                        </select>
                    </div>

                    <div class="azure-form-group">
                        <label class="label-with-tooltip">
                            SQL Server Version
                            <InfoTooltip Title="SQL Server Version">
                                The version of SQL Server to use. Version 12.0 is the latest and includes all modern features and security updates.
                                <strong>No additional cost</strong> for choosing the latest version. Recommended for new deployments.
                            </InfoTooltip>
                        </label>
                        <select @bind="NewServer.Version">
                            <option value="12.0">12.0 (Latest)</option>
                            <option value="11.0">11.0</option>
                        </select>
                    </div>
                </div>

                <div class="azure-form-section">
                    <h3>Authentication</h3>
                    
                    <div class="azure-form-group">
                        <label>Admin Username *</label>
                        <input type="text" @bind="NewServer.AdminUsername" placeholder="e.g., sqladmin" />
                        <small>Username cannot be 'admin', 'administrator', 'sa', 'root', 'dbmanager', 'loginmanager', etc.</small>
                    </div>

                    <div class="azure-form-group">
                        <label>Password *</label>
                        <input type="password" @bind="NewServer.AdminPassword" placeholder="Enter password" />
                        <small>Password must be at least 8 characters with uppercase, lowercase, numbers, and special characters.</small>
                    </div>

                    <div class="azure-form-group">
                        <label>Confirm Password *</label>
                        <input type="password" @bind="ConfirmPassword" placeholder="Confirm password" />
                        @if (!string.IsNullOrEmpty(PasswordError))
                        {
                            <div class="error">@PasswordError</div>
                        }
                    </div>
                </div>
            }
            else if (CurrentTab == 1)
            {
                <div class="azure-form-section">
                    <h3>Connectivity Method</h3>
                    <div class="azure-info-box">
                        <p>Configure network connectivity for your SQL Server. In this training environment, all settings are simulated.</p>
                    </div>
                    
                    <div class="azure-form-group">
                        <label>
                            <input type="radio" name="connectivity" checked /> Public endpoint (recommended for training)
                            <InfoTooltip Title="Public Endpoint">
                                Allows connections from the internet using firewall rules. This is the easiest option for learning and development.
                                <strong>Cost: Included</strong> - No additional networking charges for public endpoints in training scenarios.
                            </InfoTooltip>
                        </label>
                    </div>
                    
                    <div class="azure-form-group">
                        <label>
                            <input type="radio" name="connectivity" /> Private endpoint
                            <InfoTooltip Title="Private Endpoint">
                                Uses Azure Private Link to connect securely through a private IP address within your virtual network. Provides better security by not exposing your server to the public internet.
                                <strong>Cost: ~$7-10/month</strong> per private endpoint plus data processing charges.
                            </InfoTooltip>
                        </label>
                    </div>
                    
                    <div class="azure-form-group">
                        <label>
                            <input type="radio" name="connectivity" /> No access
                            <InfoTooltip Title="No Access">
                                Disables all network connectivity to the server. You won't be able to connect until you configure connectivity later.
                                <strong>Cost: $0</strong> - No networking charges, but server charges still apply.
                            </InfoTooltip>
                        </label>
                    </div>
                </div>

                <div class="azure-form-section">
                    <h3>Firewall Rules</h3>
                    <div class="azure-form-group">
                        <label>
                            <input type="checkbox" checked /> Allow Azure services and resources to access this server
                            <InfoTooltip Title="Azure Services Access">
                                Permits other Azure services (like App Services, Azure Functions, Logic Apps) to connect to your SQL Server.
                                <strong>Cost: Free</strong> - Enables seamless Azure-to-Azure connections without exposing your server publicly.
                            </InfoTooltip>
                        </label>
                        <small>Allows Azure services like App Service, Functions to connect</small>
                    </div>
                    
                    <div class="azure-form-group">
                        <label>
                            <input type="checkbox" checked /> Add current client IP address
                            <InfoTooltip Title="Client IP Firewall Rule">
                                Automatically adds your current IP address to the firewall, allowing immediate access from your computer.
                                <strong>Cost: Free</strong> - Firewall rules don't incur charges. Remember to update if your IP changes.
                            </InfoTooltip>
                        </label>
                        <small>Current IP: 192.168.1.100 (simulated)</small>
                    </div>
                </div>

                <div class="azure-form-section">
                    <h3>Connection Policy</h3>
                    
                    <div class="azure-form-group">
                        <label>
                            <input type="radio" name="connpolicy" checked /> Default
                            <InfoTooltip Title="Default Connection Policy">
                                Azure automatically chooses between Proxy and Redirect based on where the connection originates. This is the recommended setting for most scenarios.
                                <strong>Cost: Included</strong> - Optimal balance of performance and compatibility.
                            </InfoTooltip>
                        </label>
                        <small>Connection policy determines how clients connect to your SQL Server (Recommended)</small>
                    </div>
                    
                    <div class="azure-form-group">
                        <label>
                            <input type="radio" name="connpolicy" /> Proxy
                            <InfoTooltip Title="Proxy Connection Policy">
                                All connections go through the Azure SQL Database gateways. More compatible with restrictive firewalls but slightly higher latency.
                                <strong>Cost: Included</strong> - May see 5-10ms additional latency compared to Redirect.
                            </InfoTooltip>
                        </label>
                        <small>All connections are proxied via the Azure SQL Database gateways</small>
                    </div>
                    
                    <div class="azure-form-group">
                        <label>
                            <input type="radio" name="connpolicy" /> Redirect
                            <InfoTooltip Title="Redirect Connection Policy">
                                After initial connection, the client connects directly to the database node for lowest latency. Requires opening more ports (11000-11999).
                                <strong>Cost: Included</strong> - Best performance but requires specific firewall configuration.
                            </InfoTooltip>
                        </label>
                        <small>Clients establish connections directly to the node hosting the database</small>
                    </div>
                </div>

                <div class="azure-form-section">
                    <h3>Encrypted Connections</h3>
                    
                    <div class="azure-form-group">
                        <label class="label-with-tooltip">
                            Minimum TLS version
                            <InfoTooltip Title="TLS Version">
                                Transport Layer Security (TLS) encrypts data in transit. TLS 1.2 is the current standard and provides strong security.
                                <strong>Cost: Free</strong> - Encryption is included. Use TLS 1.2 for best security.
                            </InfoTooltip>
                        </label>
                        <select>
                            <option value="1.2" selected>1.2</option>
                            <option value="1.1">1.1</option>
                            <option value="1.0">1.0</option>
                        </select>
                        <small>Minimum TLS version enforced by the server</small>
                    </div>
                </div>

                <div class="azure-form-section">
                    <h3>Public Network Access</h3>
                    
                    <div class="azure-form-group">
                        <label>
                            <input type="checkbox" checked /> Enable public network access
                            <InfoTooltip Title="Public Network Access">
                                When enabled, allows connections from public IP addresses (controlled by firewall rules). Disable for maximum security using only private endpoints.
                                <strong>Cost: Free</strong> - Choice doesn't affect pricing, only security posture.
                            </InfoTooltip>
                        </label>
                        <small>Allow public network access to this server. If disabled, access is allowed only through private endpoints</small>
                    </div>
                </div>
            }
            else if (CurrentTab == 2)
            {
                <div class="azure-form-section">
                    <h3>Authentication Method</h3>
                    <div class="azure-info-box">
                        <p>Configure authentication methods for your SQL Server. In this training environment, all settings are simulated.</p>
                    </div>
                    
                    <div class="azure-form-group">
                        <label>
                            <input type="checkbox" /> Use only Microsoft Entra authentication
                            <InfoTooltip Title="Microsoft Entra (Azure AD) Authentication">
                                Uses Azure Active Directory for authentication instead of SQL Server logins. Provides centralized identity management and multi-factor authentication.
                                <strong>Cost: Included</strong> in Azure AD Basic (free). Premium features like MFA require Azure AD Premium (~$6/user/month).
                            </InfoTooltip>
                        </label>
                        <small>Use Azure Active Directory (Entra ID) authentication only, disable SQL authentication</small>
                    </div>
                    
                    <div class="azure-form-group">
                        <label>
                            <input type="checkbox" /> Set Microsoft Entra admin
                            <InfoTooltip Title="Entra Admin">
                                Designate an Azure AD user or group as the administrator for this server. This admin can manage the server using their Azure AD credentials.
                                <strong>Cost: Free</strong> - No additional cost for setting an Entra admin.
                            </InfoTooltip>
                        </label>
                        <small>Configure an Azure AD user or group as the admin for this server</small>
                    </div>
                </div>

                <div class="azure-form-section">
                    <h3>Identity</h3>
                    
                    <div class="azure-form-group">
                        <label class="label-with-tooltip">
                            System assigned managed identity
                            <InfoTooltip Title="System-Assigned Managed Identity">
                                Automatically creates an identity for your SQL Server in Azure AD. This allows the server to authenticate to other Azure services without storing credentials.
                                <strong>Cost: Free</strong> - Managed identities don't incur additional charges and improve security.
                            </InfoTooltip>
                        </label>
                        <select>
                            <option value="off" selected>Off</option>
                            <option value="on">On</option>
                        </select>
                        <small>Managed identity allows the server to authenticate to other Azure services</small>
                    </div>
                    
                    <div class="azure-form-group">
                        <label class="label-with-tooltip">
                            User assigned managed identity
                            <InfoTooltip Title="User-Assigned Managed Identity">
                                Uses a pre-created managed identity that you control. Useful when you want to share an identity across multiple resources.
                                <strong>Cost: Free</strong> - Identity creation and use are free, but you manage the lifecycle separately.
                            </InfoTooltip>
                        </label>
                        <select>
                            <option value="none" selected>None</option>
                        </select>
                        <small>Use a user-assigned managed identity</small>
                    </div>
                </div>

                <div class="azure-form-section">
                    <h3>Data Protection</h3>
                    
                    <div class="azure-form-group">
                        <label>
                            <input type="checkbox" checked /> Enable Microsoft Defender for SQL
                            <InfoTooltip Title="Microsoft Defender for SQL">
                                Provides advanced threat protection with vulnerability assessment, threat detection, and security alerts. Monitors for SQL injection, unusual access patterns, and potential threats.
                                <strong>Cost: ~$15/server/month</strong> - Essential for production environments. Includes advanced security features.
                            </InfoTooltip>
                        </label>
                        <small>Provides advanced threat protection and vulnerability assessment</small>
                    </div>
                    
                    <div class="azure-form-group">
                        <label>
                            <input type="checkbox" checked /> Enable Transparent Data Encryption (TDE)
                            <InfoTooltip Title="Transparent Data Encryption">
                                Encrypts the database files at rest, protecting data if physical media is stolen. Encryption and decryption are automatic and transparent to applications.
                                <strong>Cost: Included</strong> - TDE is free for Azure SQL and enabled by default. No performance impact.
                            </InfoTooltip>
                        </label>
                        <small>Encrypts data at rest</small>
                    </div>
                </div>

                <div class="azure-form-section">
                    <h3>Ledger</h3>
                    
                    <div class="azure-form-group">
                        <label>
                            <input type="checkbox" /> Enable ledger
                            <InfoTooltip Title="SQL Ledger">
                                Provides tamper-evidence for your database by creating a cryptographic proof of data integrity. Useful for audit and compliance scenarios.
                                <strong>Cost: Included</strong> - No additional charge for ledger features. May require additional storage for ledger tables.
                            </InfoTooltip>
                        </label>
                        <small>Provides tamper-evidence capabilities for your databases</small>
                    </div>
                </div>

                <div class="azure-form-section">
                    <h3>Auditing</h3>
                    
                    <div class="azure-form-group">
                        <label>
                            <input type="checkbox" checked /> Enable SQL Auditing
                            <InfoTooltip Title="SQL Auditing">
                                Tracks database events and writes them to an audit log. Essential for compliance and security monitoring. Logs can be sent to Azure Storage, Log Analytics, or Event Hubs.
                                <strong>Cost: Storage costs apply</strong> - ~$0.02/GB/month for storage. Log Analytics adds ~$2.30/GB ingested.
                            </InfoTooltip>
                        </label>
                        <small>Tracks database events and writes them to audit logs in your Azure storage account, Log Analytics workspace, or Event Hubs</small>
                    </div>
                </div>
            }
            else if (CurrentTab == 3)
            {
                <div class="azure-form-section">
                    <h3>Data Source</h3>
                    
                    <div class="azure-form-group">
                        <label class="label-with-tooltip">
                            Start with
                            <InfoTooltip Title="Initial Data Source">
                                Choose whether to start with an empty server or load sample data. Sample data is useful for learning and testing.
                                <strong>Cost: Free</strong> - Sample data doesn't add to costs beyond normal storage.
                            </InfoTooltip>
                        </label>
                        <select>
                            <option value="none" selected>None (blank server)</option>
                            <option value="sample">Sample</option>
                        </select>
                        <small>Start with a blank server or restore from a backup</small>
                    </div>
                </div>

                <div class="azure-form-section">
                    <h3>Server Configuration</h3>
                    
                    <div class="azure-form-group">
                        <label class="label-with-tooltip">
                            Server collation
                            <InfoTooltip Title="Server Collation">
                                Determines how the server sorts and compares text data. CI = Case Insensitive, AS = Accent Sensitive. Default works for most scenarios.
                                <strong>Cost: Free</strong> - Choice doesn't affect costs. Difficult to change later, so choose carefully.
                            </InfoTooltip>
                        </label>
                        <select>
                            <option value="SQL_Latin1_General_CP1_CI_AS" selected>SQL_Latin1_General_CP1_CI_AS (Default)</option>
                            <option value="SQL_Latin1_General_CP1_CS_AS">SQL_Latin1_General_CP1_CS_AS</option>
                            <option value="Latin1_General_CI_AS">Latin1_General_CI_AS</option>
                            <option value="Latin1_General_CS_AS">Latin1_General_CS_AS</option>
                        </select>
                        <small>Collation determines sorting and comparison rules for character data</small>
                    </div>
                </div>

                <div class="azure-form-section">
                    <h3>Maintenance Window</h3>
                    <div class="azure-info-box">
                        <p>Choose a maintenance window for system updates and patches</p>
                    </div>
                    
                    <div class="azure-form-group">
                        <label>
                            <input type="radio" name="maintenance" checked /> System default (5pm to 8am local time)
                            <InfoTooltip Title="System Default Maintenance">
                                Azure automatically schedules maintenance during off-peak hours. Most reliable option as Azure optimizes timing.
                                <strong>Cost: Free</strong> - No difference in pricing between maintenance windows.
                            </InfoTooltip>
                        </label>
                    </div>
                    
                    <div class="azure-form-group">
                        <label>
                            <input type="radio" name="maintenance" /> Weekday window
                            <InfoTooltip Title="Weekday Maintenance Window">
                                Schedules maintenance Monday to Thursday nights (10pm-6am). Good if weekends are critical for your business.
                                <strong>Cost: Free</strong> - Same cost as other windows, just different timing.
                            </InfoTooltip>
                        </label>
                        <small>Monday to Thursday 10pm to 6am local time</small>
                    </div>
                    
                    <div class="azure-form-group">
                        <label>
                            <input type="radio" name="maintenance" /> Weekend window
                            <InfoTooltip Title="Weekend Maintenance Window">
                                Schedules maintenance Friday night through Monday morning. Ideal if weekdays are your peak business time.
                                <strong>Cost: Free</strong> - Choose based on your business needs, not cost.
                            </InfoTooltip>
                        </label>
                        <small>Friday 10pm to Monday 6am local time</small>
                    </div>
                </div>
            }
            else if (CurrentTab == 4)
            {
                <div class="azure-form-section">
                    <h3>Tags</h3>
                    <div class="azure-info-box">
                        <p>Tags are name/value pairs that enable you to categorize resources and view consolidated billing by applying the same tag to multiple resources and resource groups.</p>
                    </div>

                    <p style="font-size:14px; color:#605e5c; margin-bottom:16px;">
                        Note that if you create tags and then change resource settings on other tabs, your tags will be automatically updated.
                    </p>
                    
                    @if (Tags.Any())
                    {
                        <table class="azure-table" style="margin-bottom: 16px;">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Value</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < Tags.Count; i++)
                                {
                                    var index = i;
                                    <tr>
                                        <td>
                                            <input type="text" @bind="Tags[index].Key" style="width: 100%;" />
                                        </td>
                                        <td>
                                            <input type="text" @bind="Tags[index].Value" style="width: 100%;" />
                                        </td>
                                        <td>
                                            <button class="azure-link-button" @onclick='() => RemoveTag(index)'>Delete</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    
                    <button class="azure-button azure-button-secondary" @onclick="AddTag">+ Add tag pair</button>
                </div>

                <div class="azure-form-section">
                    <h3>Common tags (optional)</h3>
                    <p style="font-size:14px; color:#605e5c; margin-bottom:12px;">Select from commonly used tags:</p>
                    
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="azure-button azure-button-secondary" @onclick='() => AddPredefinedTag("Environment", "Development")'>Environment: Development</button>
                        <button class="azure-button azure-button-secondary" @onclick='() => AddPredefinedTag("Environment", "Production")'>Environment: Production</button>
                        <button class="azure-button azure-button-secondary" @onclick='() => AddPredefinedTag("Environment", "Test")'>Environment: Test</button>
                        <button class="azure-button azure-button-secondary" @onclick='() => AddPredefinedTag("Department", "IT")'>Department: IT</button>
                        <button class="azure-button azure-button-secondary" @onclick='() => AddPredefinedTag("CostCenter", "")'>Cost Center</button>
                        <button class="azure-button azure-button-secondary" @onclick='() => AddPredefinedTag("Owner", "")'>Owner</button>
                        <button class="azure-button azure-button-secondary" @onclick='() => AddPredefinedTag("Project", "")'>Project</button>
                    </div>
                </div>
            }
            else if (CurrentTab == 5)
            {
                <div class="azure-form-section">
                    <h3>Review + create</h3>
                    
                    <div class="azure-info-box" style="background-color: #dff6dd; border-left-color: #107c10;">
                        <p><strong>? Validation passed</strong></p>
                    </div>

                    <h4 style="margin-top:24px; margin-bottom:12px; font-size:16px; font-weight:600;">Basics</h4>
                    <table class="azure-table">
                        <tr>
                            <td style="width: 200px;"><strong>Subscription</strong></td>
                            <td>Azure for Students</td>
                        </tr>
                        <tr>
                            <td><strong>Resource Group</strong></td>
                            <td>@(ShowNewResourceGroup ? NewResourceGroupName : NewServer.ResourceGroup)</td>
                        </tr>
                        <tr>
                            <td><strong>Server Name</strong></td>
                            <td>@(NewServer.Name).database.windows.net</td>
                        </tr>
                        <tr>
                            <td><strong>Location</strong></td>
                            <td>@NewServer.Location</td>
                        </tr>
                        <tr>
                            <td><strong>Version</strong></td>
                            <td>@NewServer.Version</td>
                        </tr>
                        <tr>
                            <td><strong>Admin Username</strong></td>
                            <td>@NewServer.AdminUsername</td>
                        </tr>
                    </table>

                    <h4 style="margin-top:24px; margin-bottom:12px; font-size:16px; font-weight:600;">Networking</h4>
                    <table class="azure-table">
                        <tr>
                            <td style="width: 200px;"><strong>Connectivity</strong></td>
                            <td>Public endpoint</td>
                        </tr>
                        <tr>
                            <td><strong>Firewall Rules</strong></td>
                            <td>Allow Azure services, Current client IP</td>
                        </tr>
                        <tr>
                            <td><strong>Connection Policy</strong></td>
                            <td>Default</td>
                        </tr>
                        <tr>
                            <td><strong>Minimum TLS Version</strong></td>
                            <td>1.2</td>
                        </tr>
                        <tr>
                            <td><strong>Public Network Access</strong></td>
                            <td>Enabled</td>
                        </tr>
                    </table>

                    <h4 style="margin-top:24px; margin-bottom:12px; font-size:16px; font-weight:600;">Security</h4>
                    <table class="azure-table">
                        <tr>
                            <td style="width: 200px;"><strong>Authentication</strong></td>
                            <td>SQL authentication</td>
                        </tr>
                        <tr>
                            <td><strong>Microsoft Defender</strong></td>
                            <td>Enabled</td>
                        </tr>
                        <tr>
                            <td><strong>TDE</strong></td>
                            <td>Enabled</td>
                        </tr>
                        <tr>
                            <td><strong>Ledger</strong></td>
                            <td>Disabled</td>
                        </tr>
                        <tr>
                            <td><strong>Auditing</strong></td>
                            <td>Enabled</td>
                        </tr>
                    </table>

                    <h4 style="margin-top:24px; margin-bottom:12px; font-size:16px; font-weight:600;">Additional Settings</h4>
                    <table class="azure-table">
                        <tr>
                            <td style="width: 200px;"><strong>Data Source</strong></td>
                            <td>None</td>
                        </tr>
                        <tr>
                            <td><strong>Collation</strong></td>
                            <td>SQL_Latin1_General_CP1_CI_AS</td>
                        </tr>
                        <tr>
                            <td><strong>Maintenance Window</strong></td>
                            <td>System default</td>
                        </tr>
                    </table>

                    @if (Tags.Any(t => !string.IsNullOrWhiteSpace(t.Key)))
                    {
                        <h4 style="margin-top:24px; margin-bottom:12px; font-size:16px; font-weight:600;">Tags</h4>
                        <table class="azure-table">
                            @foreach (var tag in Tags.Where(t => !string.IsNullOrWhiteSpace(t.Key)))
                            {
                                <tr>
                                    <td style="width: 200px;"><strong>@tag.Key</strong></td>
                                    <td>@tag.Value</td>
                                </tr>
                            }
                        </table>
                    }

                    <div class="azure-info-box" style="margin-top: 24px;">
                        <p><strong>Estimated Cost:</strong> $0.00/month (Training Environment - No actual costs)</p>
                    </div>

                    <div class="azure-info-box" style="margin-top: 16px;">
                        <p><strong>Training Environment:</strong> This is a simulated SQL Server. No actual Azure resources or costs will be incurred.</p>
                    </div>
                </div>
            }
        </div>

        <div class="azure-wizard-footer">
            <div>
                @if (CurrentTab > 0)
                {
                    <button class="azure-button azure-button-secondary" @onclick="PreviousTab">
                        Previous
                    </button>
                }
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="azure-button azure-button-secondary" @onclick='() => Navigation.NavigateTo("/sql-servers")'>
                    Cancel
                </button>
                @if (CurrentTab < 5)
                {
                    <button class="azure-button azure-button-primary" @onclick="NextTab">
                        Next: @GetNextTabName()
                    </button>
                }
                else
                {
                    <button class="azure-button azure-button-primary" @onclick="CreateServer" disabled="@IsCreating">
                        @(IsCreating ? "Creating..." : "Create")
                    </button>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Inject]
    private NavigationManager Navigation { get; set; } = default!;

    [Inject]
    private AzureResourceService ResourceService { get; set; } = default!;

    private SqlServer NewServer { get; set; } = new();
    private string ConfirmPassword { get; set; } = string.Empty;
    private string NewResourceGroupName { get; set; } = string.Empty;
    private bool ShowNewResourceGroup { get; set; } = false;
    private int CurrentTab { get; set; } = 0;
    private bool IsCreating { get; set; } = false;
    private string ServerNameError { get; set; } = string.Empty;
    private string PasswordError { get; set; } = string.Empty;
    private List<TagPair> Tags { get; set; } = new();

    private List<ResourceGroup> ResourceGroups { get; set; } = new();
    private List<string> Locations { get; set; } = new();

    protected override void OnInitialized()
    {
        ResourceGroups = ResourceService.GetResourceGroups();
        Locations = ResourceService.GetLocations();
    }

    private void ShowCreateResourceGroup(MouseEventArgs e)
    {
        ShowNewResourceGroup = !ShowNewResourceGroup;
    }

    private string GetNextTabName()
    {
        return CurrentTab switch
        {
            0 => "Networking",
            1 => "Security",
            2 => "Additional settings",
            3 => "Tags",
            4 => "Review + create",
            _ => ""
        };
    }

    private void NextTab()
    {
        if (CurrentTab == 0 && !ValidateBasics())
            return;

        if (CurrentTab < 5)
            CurrentTab++;
    }

    private void PreviousTab()
    {
        if (CurrentTab > 0)
            CurrentTab--;
    }

    private void AddTag()
    {
        Tags.Add(new TagPair { Key = "", Value = "" });
    }

    private void RemoveTag(int index)
    {
        if (index >= 0 && index < Tags.Count)
        {
            Tags.RemoveAt(index);
        }
    }

    private void AddPredefinedTag(string key, string value)
    {
        if (!Tags.Any(t => t.Key.Equals(key, StringComparison.OrdinalIgnoreCase)))
        {
            Tags.Add(new TagPair { Key = key, Value = value });
        }
    }

    private bool ValidateBasics()
    {
        ServerNameError = string.Empty;
        PasswordError = string.Empty;

        if (string.IsNullOrWhiteSpace(NewServer.Name))
        {
            ServerNameError = "Server name is required";
            return false;
        }

        if (!System.Text.RegularExpressions.Regex.IsMatch(NewServer.Name, "^[a-z0-9-]+$"))
        {
            ServerNameError = "Server name must contain only lowercase letters, numbers, and hyphens";
            return false;
        }

        if (NewServer.Name.Length < 1 || NewServer.Name.Length > 63)
        {
            ServerNameError = "Server name must be between 1 and 63 characters";
            return false;
        }

        if (NewServer.Name.StartsWith('-') || NewServer.Name.EndsWith('-'))
        {
            ServerNameError = "Server name cannot start or end with a hyphen";
            return false;
        }

        // Check reserved names
        string[] reservedNames = { "admin", "administrator", "sa", "root", "dbmanager", "loginmanager", "dbo", "guest", "public" };
        if (reservedNames.Contains(NewServer.AdminUsername?.ToLower()))
        {
            PasswordError = $"Username '{NewServer.AdminUsername}' is reserved and cannot be used";
            return false;
        }

        if (string.IsNullOrWhiteSpace(NewServer.ResourceGroup) && !ShowNewResourceGroup)
        {
            ServerNameError = "Resource group is required";
            return false;
        }

        if (ShowNewResourceGroup && string.IsNullOrWhiteSpace(NewResourceGroupName))
        {
            ServerNameError = "Resource group name is required";
            return false;
        }

        if (string.IsNullOrWhiteSpace(NewServer.Location))
        {
            ServerNameError = "Location is required";
            return false;
        }

        if (string.IsNullOrWhiteSpace(NewServer.AdminUsername))
        {
            PasswordError = "Admin username is required";
            return false;
        }

        if (string.IsNullOrWhiteSpace(NewServer.AdminPassword))
        {
            PasswordError = "Password is required";
            return false;
        }

        if (NewServer.AdminPassword.Length < 8)
        {
            PasswordError = "Password must be at least 8 characters long";
            return false;
        }

        // Password complexity check
        bool hasUpper = NewServer.AdminPassword.Any(char.IsUpper);
        bool hasLower = NewServer.AdminPassword.Any(char.IsLower);
        bool hasDigit = NewServer.AdminPassword.Any(char.IsDigit);
        bool hasSpecial = NewServer.AdminPassword.Any(ch => !char.IsLetterOrDigit(ch));

        if (!hasUpper || !hasLower || !hasDigit || !hasSpecial)
        {
            PasswordError = "Password must contain uppercase, lowercase, numbers, and special characters";
            return false;
        }

        if (NewServer.AdminPassword != ConfirmPassword)
        {
            PasswordError = "Passwords do not match";
            return false;
        }

        return true;
    }

    private async Task CreateServer()
    {
        if (!ValidateBasics())
        {
            CurrentTab = 0;
            return;
        }

        IsCreating = true;
        
        // Simulate deployment delay
        await Task.Delay(2000);

        // Create resource group if needed
        if (ShowNewResourceGroup)
        {
            ResourceService.CreateResourceGroup(new ResourceGroup
            {
                Name = NewResourceGroupName,
                Location = NewServer.Location
            });
            NewServer.ResourceGroup = NewResourceGroupName;
        }

        // Create the SQL Server
        ResourceService.CreateSqlServer(NewServer);

        Navigation.NavigateTo($"/sql-servers/{NewServer.Name}");
    }

    private class TagPair
    {
        public string Key { get; set; } = string.Empty;
        public string Value { get; set; } = string.Empty;
    }
}
